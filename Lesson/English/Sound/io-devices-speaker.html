<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>

  
    <meta name="generator" content="HTML Tidy, see www.w3.org"><title>Internal Speaker</title>
    
    <meta name="GENERATOR" content="Modular DocBook HTML Stylesheet Version 1.73 ">
    <link rel="HOME" title="January 2003 Laboratory Notes" href="http://courses.ece.uiuc.edu/ece390/books/labmanual/index.html">
    <link rel="UP" title="I/O Devices" href="http://courses.ece.uiuc.edu/ece390/books/labmanual/io-devices.html">
    <link rel="PREVIOUS" title="8253 Timer Chip" href="http://courses.ece.uiuc.edu/ece390/books/labmanual/io-devices-timer.html">
    <link rel="NEXT" title="Graphics" href="http://courses.ece.uiuc.edu/ece390/books/labmanual/graphics.html">
    <link rel="STYLESHEET" type="text/css" href="io-devices-speaker_files/docbook.htm"></head><body class="SECT1" alink="#0000ff" bgcolor="#ffffff" link="#0000ff" text="#000000" vlink="#840084">
    <div class="NAVHEADER">
      <table summary="Header navigation table" border="0" cellpadding="0" cellspacing="0" width="100%">
        <tbody><tr>
          <th colspan="3" align="center">January 2003 Laboratory
          Notes: Computer Engineering II</th>
        </tr>

        <tr>
          <td align="left" valign="bottom" width="10%"><a href="http://courses.ece.uiuc.edu/ece390/books/labmanual/io-devices-timer.html" accesskey="P">Prev</a></td>

          <td align="center" valign="bottom" width="80%">Chapter 10
          I/O Devices</td>

          <td align="right" valign="bottom" width="10%"><a href="http://courses.ece.uiuc.edu/ece390/books/labmanual/graphics.html" accesskey="N">Next</a></td>
        </tr>
      </tbody></table>
      <hr align="left" width="100%">
    </div>

    <div class="SECT1">
      <h1 class="SECT1"><a name="IO-DEVICES-SPEAKER">10.4 Internal
      Speaker</a></h1>

      <div class="SECT2">
        <h2 class="SECT2"><a name="IO-DEVICES-SPEAKER-INTERFACE">10.4.1 The Speaker
        Interface</a></h2>

        <p>The PC has an internal speaker which is capable of
        generating beeps of different frequencies. You control the
        speaker by providing a frequency number which determines
        the pitch of the beep, then turning the speaker on for the
        duration of the beep.</p>

        <p>The frequency number you provide is actually a counter
        value. The PC uses it to determine how long to wait between
        sending pulses to the speaker. A smaller frequency number
        will cause the pulses to be sent quicker, resulting in a
        higher pitch. The PC uses a base rate of 1,193,180 Hz (this
        frequency is generated by an oscillator chip). The
        frequency number tells the PC how many of these cycles to
        wait before sending another pulse. Thus, you can calculate
        the frequency number required to generate a specific
        frequency by the following formula:</p>

        <div class="INFORMALEQUATION">
          <a name="AEN5319"></a><img src="io-devices-speaker_files/speakerfreq.htm">
        </div>

        <p>The frequency number is a word value, so it can take
        values between 0 and 65,535 inclusive. This means you can
        generate any frequency between 18.21 Hz (frequency number =
        65,535) and 1,193,180 Hz (frequency number = 1).</p>

        <p><a href="http://courses.ece.uiuc.edu/ece390/books/labmanual/io-devices-speaker.html#IO-DEVICES-FIG-SPEAKER">Figure
        10-1</a> is a diagram of the hardware for driving the
        built-in speaker. OUT2 is the output of Channel 2 of the
        8253-5 timer chip, GATE2 (= bit 1 of port 61h) is the
        enable/trigger control for the Channel 2 counter, and
        SPEAKER DATA (= bit 0 of port 61h) is a line that may be
        used independently to modulate the output waveform, e.g.,
        to control the speaker volume.</p>

        <div class="FIGURE">
          <a name="IO-DEVICES-FIG-SPEAKER"></a>

          <p><b>Figure 10-1. Built-in speaker hardware</b></p>
          <img src="io-devices-speaker_files/speaker.png">
        </div>

        <p>The count and load modes selected for Channel 2 during
        BIOS initialization are probably the best to use for tone
        production. In Mode 3, the counter output is a continuous
        symmetrical square wave as long as the GATE line of the
        channel is enabled; the other modes either produce outputs
        that are too asymmetrical or require retriggering for each
        count cycle.</p>

        <p>The frequency count is loaded into the Channel 2 COUNT
        register at I/O port 42h. GATE2 (bit 1 of I/O port 61h)
        must be set to 1 to get an output on OUT2; the SPEAKER DATA
        line (bit 0 of I/O port 61h) must also be set to 1 to
        produce a tone. Note that the remaining bits of port 61h
        must not be changed since they control RAM enable, keyboard
        clock, etc. To silence the speaker, bits 1 or 0 of port 61h
        are set to 0 (without disturbing the remaining bits of port
        61h).</p>
      </div>

      <div class="SECT2">
        <h2 class="SECT2"><a name="IO-DEVICES-SPEAKER-SOUNDS">10.4.2 Generating
        Sounds</a></h2>

        <p>You can communicate with the speaker controller using IN
        and OUT instructions. The following lists the steps in
        generating a beep:</p>

        <div class="PROCEDURE">
          <ol type="1">
            <li>
              <p>Send the value 182 to port 43h. This sets up the
              speaker.</p>
            </li>

            <li>
              <p>Send the frequency number to port 42h. Since this
              is an 8-bit port, you must use two <tt class="LITERAL">OUT</tt> instructions to do this. Send the
              least significant byte first, then the most
              significant byte.</p>
            </li>

            <li>
              <p>To start the beep, bits 1 and 0 of port 61h must
              be set to 1. Since the other bits of port 61h have
              other uses, they must not be modified. Therefore, you
              must use an <tt class="LITERAL">IN</tt> instruction
              first to get the value from the port, then do an OR
              to set the two bits, then use an <tt class="LITERAL">OUT</tt> instruction to send the new value
              to the port.</p>
            </li>

            <li>
              <p>Pause for the duration of the beep.</p>
            </li>

            <li>
              <p>Turn off the beep by resetting bits 1 and 0 of
              port 61h to 0. Remember that since the other bits of
              this port must not be modified, you must read the
              value, set just bits 1 and 0 to 0, then output the
              new value.</p>
            </li>
          </ol>
        </div>

        <p>The following code fragment generates a beep with a
        frequency of 261.63 Hz (middle C on a piano keyboard) and a
        duration of approximately one second:</p>
<pre class="PROGRAMLISTING">        mov     al, 182         ; Prepare the speaker for the
        out     43h, al         ;  note.
        mov     ax, 4560        ; Frequency number (in decimal)
                                ;  for middle C.
        out     42h, al         ; Output low byte.
        mov     al, ah          ; Output high byte.
        out     42h, al 
        in      al, 61h         ; Turn on note (get value from
                                ;  port 61h).
        or      al, 00000011b   ; Set bits 1 and 0.
        out     61h, al         ; Send new value.
        mov     bx, 25          ; Pause for duration of note.
.pause1:
        mov     cx, 65535
.pause2:
        dec     cx
        jne     .pause2
        dec     bx
        jne     .pause1
        in      al, 61h         ; Turn off note (get value from
                                ;  port 61h).
        and     al, 11111100b   ; Reset bits 1 and 0.
        out     61h, al         ; Send new value.
</pre>

        <p>Another way to control the length of beeps is to use the
        timer interrupt. This gives you better control over the
        duration of the note and it also allows your program to
        perform other tasks while the note is playing.</p>
      </div>

      <div class="SECT2">
        <h2 class="SECT2"><a name="IO-DEVICES-SPEAKER-FREQTABLE">10.4.3 Frequency
        Table</a></h2>

        <p>The following table lists frequencies and frequency
        numbers for the three octaves around middle C on a piano
        keyboard.</p>

        <div class="INFORMALTABLE">
          <a name="AEN5358"></a>

          <table class="CALSTABLE" border="0">
            <thead>
              <tr>
                <th align="left" valign="top" width="33%">Note</th>

                <th align="left" valign="top" width="33%">
                Frequency</th>

                <th align="left" valign="top" width="33%">Frequency
                #</th>
              </tr>
            </thead>

            <tbody>
              <tr>
                <td align="left" valign="top" width="33%">C</td>

                <td align="left" valign="top" width="33%">
                130.81</td>

                <td align="left" valign="top" width="33%">9121</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">C#</td>

                <td align="left" valign="top" width="33%">
                138.59</td>

                <td align="left" valign="top" width="33%">8609</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">D</td>

                <td align="left" valign="top" width="33%">
                146.83</td>

                <td align="left" valign="top" width="33%">8126</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">D#</td>

                <td align="left" valign="top" width="33%">
                155.56</td>

                <td align="left" valign="top" width="33%">7670</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">E</td>

                <td align="left" valign="top" width="33%">
                164.81</td>

                <td align="left" valign="top" width="33%">7239</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">F</td>

                <td align="left" valign="top" width="33%">
                174.61</td>

                <td align="left" valign="top" width="33%">6833</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">F#</td>

                <td align="left" valign="top" width="33%">
                185.00</td>

                <td align="left" valign="top" width="33%">6449</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">G</td>

                <td align="left" valign="top" width="33%">
                196.00</td>

                <td align="left" valign="top" width="33%">6087</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">G#</td>

                <td align="left" valign="top" width="33%">
                207.65</td>

                <td align="left" valign="top" width="33%">5746</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">A</td>

                <td align="left" valign="top" width="33%">
                220.00</td>

                <td align="left" valign="top" width="33%">5423</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">A#</td>

                <td align="left" valign="top" width="33%">
                233.08</td>

                <td align="left" valign="top" width="33%">5119</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">B</td>

                <td align="left" valign="top" width="33%">
                246.94</td>

                <td align="left" valign="top" width="33%">4831</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">Middle
                C</td>

                <td align="left" valign="top" width="33%">
                261.63</td>

                <td align="left" valign="top" width="33%">4560</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">C#</td>

                <td align="left" valign="top" width="33%">
                277.18</td>

                <td align="left" valign="top" width="33%">4304</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">D</td>

                <td align="left" valign="top" width="33%">
                293.66</td>

                <td align="left" valign="top" width="33%">4063</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">D#</td>

                <td align="left" valign="top" width="33%">
                311.13</td>

                <td align="left" valign="top" width="33%">3834</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">E</td>

                <td align="left" valign="top" width="33%">
                329.63</td>

                <td align="left" valign="top" width="33%">3619</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">F</td>

                <td align="left" valign="top" width="33%">
                349.23</td>

                <td align="left" valign="top" width="33%">3416</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">F#</td>

                <td align="left" valign="top" width="33%">
                369.99</td>

                <td align="left" valign="top" width="33%">3224</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">G</td>

                <td align="left" valign="top" width="33%">
                391.00</td>

                <td align="left" valign="top" width="33%">3043</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">G#</td>

                <td align="left" valign="top" width="33%">
                415.30</td>

                <td align="left" valign="top" width="33%">2873</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">A</td>

                <td align="left" valign="top" width="33%">
                440.00</td>

                <td align="left" valign="top" width="33%">2711</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">A#</td>

                <td align="left" valign="top" width="33%">
                466.16</td>

                <td align="left" valign="top" width="33%">2559</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">B</td>

                <td align="left" valign="top" width="33%">
                493.88</td>

                <td align="left" valign="top" width="33%">2415</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">C</td>

                <td align="left" valign="top" width="33%">
                523.25</td>

                <td align="left" valign="top" width="33%">2280</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">C#</td>

                <td align="left" valign="top" width="33%">
                554.37</td>

                <td align="left" valign="top" width="33%">2152</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">D</td>

                <td align="left" valign="top" width="33%">
                587.33</td>

                <td align="left" valign="top" width="33%">2031</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">D#</td>

                <td align="left" valign="top" width="33%">
                622.25</td>

                <td align="left" valign="top" width="33%">1917</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">E</td>

                <td align="left" valign="top" width="33%">
                659.26</td>

                <td align="left" valign="top" width="33%">1809</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">F</td>

                <td align="left" valign="top" width="33%">
                698.46</td>

                <td align="left" valign="top" width="33%">1715</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">F#</td>

                <td align="left" valign="top" width="33%">
                739.99</td>

                <td align="left" valign="top" width="33%">1612</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">G</td>

                <td align="left" valign="top" width="33%">
                783.99</td>

                <td align="left" valign="top" width="33%">1521</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">G#</td>

                <td align="left" valign="top" width="33%">
                830.61</td>

                <td align="left" valign="top" width="33%">1436</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">A</td>

                <td align="left" valign="top" width="33%">
                880.00</td>

                <td align="left" valign="top" width="33%">1355</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">A#</td>

                <td align="left" valign="top" width="33%">
                923.33</td>

                <td align="left" valign="top" width="33%">1292</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">B</td>

                <td align="left" valign="top" width="33%">
                987.77</td>

                <td align="left" valign="top" width="33%">1207</td>
              </tr>

              <tr>
                <td align="left" valign="top" width="33%">C</td>

                <td align="left" valign="top" width="33%">
                1046.50</td>

                <td align="left" valign="top" width="33%">1140</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="NAVFOOTER">
      <hr align="left" width="100%">

      <table summary="Footer navigation table" border="0" cellpadding="0" cellspacing="0" width="100%">
        <tbody><tr>
          <td align="left" valign="top" width="33%"><a href="http://courses.ece.uiuc.edu/ece390/books/labmanual/io-devices-timer.html" accesskey="P">Prev</a></td>

          <td align="center" valign="top" width="34%"><a href="http://courses.ece.uiuc.edu/ece390/books/labmanual/index.html" accesskey="H">Home</a></td>

          <td align="right" valign="top" width="33%"><a href="http://courses.ece.uiuc.edu/ece390/books/labmanual/graphics.html" accesskey="N">Next</a></td>
        </tr>

        <tr>
          <td align="left" valign="top" width="33%">8253 Timer
          Chip</td>

          <td align="center" valign="top" width="34%"><a href="http://courses.ece.uiuc.edu/ece390/books/labmanual/io-devices.html" accesskey="U">Up</a></td>

          <td align="right" valign="top" width="33%">Graphics</td>
        </tr>
      </tbody></table>
    </div>
  </body></html>