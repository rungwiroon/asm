<html>
<!-- Generated by Harlequin WebMaker 2.2.6 (30-Apr-1996)Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->


<!-- Mirrored from www.arl.wustl.edu/~lockwood/class/cs306/books/artofasm/Chapter_19/CH19-3.html by HTTrack Website Copier/3.x [XR&CO'2008], Fri, 05 Dec 2008 15:28:45 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta http-equiv="pragma" content="no-cache">
<title>CHAPTER NINETEEN: PROCESSES, COROUTINES AND CONCURRENCY (Part 3)</title>
</head>

<body stylesrc="../toc.html" topmargin="10" bgcolor="#FFFFFF" text="#000000" link="#008000" vlink="#000000">
<div align="center"><center>

<table border="0" width="100%" cellspacing="0" cellpadding="0">
  <tr>
    <td width="100%" colspan="3"><p align="right"><a name="top"></a><font size="1" face="Arial">The Art of<br>
    </font><font face="Arial Black" size="1">ASSEMBLY LANGUAGE PROGRAMMING</font></td>
  </tr>
  <tr>
    <td width="100%" valign="middle" align="center" nowrap bgcolor="#000000" height="1" colspan="3"><a NAME="HEADING3"></a></td>
  </tr>
  <tr>
    <td width="34%" valign="middle" align="center" bgcolor="#FFFFFF" height="25" nowrap><p align="left"><a href="CH19-2.html"><img src="../images/WB00823_.GIF" align="absmiddle" border="0" WIDTH="12" HEIGHT="24"></a> <font face="Arial" size="2"><strong><a href="CH19-2.html">Chapter Nineteen</a>
    (Part 2)</strong></font></td>
    <td width="33%" valign="middle" align="center" bgcolor="#FFFFFF" height="25" nowrap><font face="Arial" size="2"><strong><a href="../toc.html">Table of Content</a></strong></font></td>
    <td width="33%" valign="middle" align="center" bgcolor="#FFFFFF" height="25" nowrap><font face="Arial" size="2"><strong><p align="right"><a href="CH19-4.html">Chapter Nineteen</a>
    (Part 4) <a href="CH19-4.html"><img src="../images/WB00827_.GIF" align="absmiddle" border="0" WIDTH="12" HEIGHT="24"></a></strong></font></td>
  </tr>
</table>
</center></div><div align="center"><center>

<table border="0" width="100%" cellspacing="0" cellpadding="0">
  <tr>
    <td width="100%" nowrap height="10"><a NAME="HEADING3-1"></a></td>
  </tr>
  <tr>
    <td width="100%" bgcolor="#F0F0F0"><font face="Arial" size="4"><strong>CHAPTER NINETEEN:<br>
    PROCESSES, COROUTINES AND CONCURRENCY (Part 3)</strong></font></td>
  </tr>
  <tr>
    <td width="100%" nowrap height="10"></td>
  </tr>
  <tr>
    <td width="100%"><font face="Arial" size="2"><a HREF="#HEADING3-1"><b>19.1.4 </b>-
    Exception Handling in DOS: Traps</a> <br>
    <a HREF="#HEADING3-4"><b>19.1.5 </b>- Redirection of I/O for Child Processes</a> </font></td>
  </tr>
</table>
</center></div>

<h3><strong><font face="Arial" size="3">19.1.4 Exception Handling in DOS: Traps</font></strong></h3>

<p><font face="Arial" size="2">In addition to the break and critical error exceptions,
there are the 80x86 exceptions that can happen during the execution of your programs.
Examples include the divide error exception, bounds exception, and illegal opcode
exception. A well-written application will always handle all possible exceptions.</font></p>

<p><font face="Arial" size="2">DOS does not provide direct support for these exceptions,
other than a possible default handler. In particular, DOS does not restore such vectors
when the program terminates; this is something the application, break handler, and
critical error handler must take care of. </font></p>

<p><strong><font face="Arial" size="3"><a NAME="HEADING3-4"></a>19.1.5 Redirection of I/O
for Child Processes</font></strong></p>

<p><font face="Arial" size="2">When a child process begins execution, it inherits all open
files from the parent process (with the exception of certain files opened with networking
file functions). In particular, this includes the default files opened for the DOS
standard input, standard output, standard error, auxiliary, and printer devices. DOS
assigns the file handle values zero through four, respectively, to these devices. If a
parent process closes one of these file handles and then reassigns the handle with a Force
Duplicate File Handle call.</font></p>

<p><font face="Arial" size="2">Note that the DOS EXEC call does not process the I/O
redirection operators (&quot;&lt;&quot;, and &quot;&gt;&quot;, and &quot;|&quot;). If you
want to redirect the standard I/O of a child process, you must do this before loading and
executing the child process. To redirect one of the five standard I/O devices, you should
do the following steps:</font></p>

<p><font face="Arial" size="2">1) Duplicate the file handle you want to redirect (e.g., to
redirect the standard output, duplicate file handle one).</font></p>

<p><font face="Arial" size="2">2) Close the affected file (e.g., file handle one for
standard output).</font></p>

<p><font face="Arial" size="2">3) Open a file using the standard DOS Create or CreateNew
calls.</font></p>

<p><font face="Arial" size="2">4) Use the Force Duplicate File Handle call to copy the new
file handle to file handle one.</font></p>

<p><font face="Arial" size="2">5) Run the child process.</font></p>

<p><font face="Arial" size="2">6) On return from the child, close the file.</font></p>

<p><font face="Arial" size="2">7) Copy the file handle you duplicated in step one back to
the standard output file handle using the Force Duplicate Handle function.</font></p>

<p><font face="Arial" size="2">This technique looks like it would be perfect for
redirecting printer or serial port I/O. Unfortunately, many programs bypass DOS when
sending data to the printer and use the BIOS call or, worse yet, go directly to the
hardware. Almost no software bothers with DOS' serial port support - it truly is that bad.
However, most programs do call DOS to input or output characters on the standard input,
output, and error devices. The following code demonstrates how to redirect the output of a
child process to a file.</font></p>

<pre><font face="Courier New" size="2">; REDIRECT.ASM -Demonstrates how to redirect I/O for a child process.
; This particular program invokes COMMAND.COM to execute
; a DIR command, when is sent to the specified output file.

                include stdlib.a
                includelib      stdlib.lib

dseg            segment para public 'data'

OrigOutHandle   word    ?                       ;Holds copy of STDOUT handle.
FileHandle      word    ?                       ;File I/O handle.
FileName        byte    &quot;dirctry.txt&quot;,0         ;Filename for output data.

; MS-DOS EXEC structure.

ExecStruct      word    0                       ;Use parent's Environment blk.
                dword   CmdLine                 ;For the cmd ln parms.
                dword   DfltFCB
                dword   DfltFCB

DfltFCB         byte    3,&quot; &quot;,0,0,0,0,0
CmdLine         byte    7, &quot; /c DIR&quot;, 0dh       ;Do a directory command.
PgmName         dword   PgmNameStr              ;Points at pgm name.
PgmNameStr      byte    &quot;c:\command.com&quot;,0
dseg            ends

cseg            segment para public 'code'
                assume  cs:cseg, ds:dseg


Main            proc
                mov     ax, dseg                ;Get ptr to vars segment
                mov     ds, ax
                MemInit                         ;Start the memory mgr.

; Free up some memory for COMMAND.COM:

                mov     ah, 62h                 ;Get our PSP value
                int     21h
                mov     es, bx
                mov     ax, zzzzzzseg           ;Compute size of
                sub     ax, bx                  ; resident run code.
                mov     bx, ax
                mov     ah, 4ah                 ;Release unused memory.
                int     21h

; Save original output file handle.

                mov     bx, 1                   ;Std out is file handle 1.
                mov     ah, 45h                 ;Duplicate the file handle.
                int     21h
                mov OrigOutHandle, ax           ;Save duplicate handle.

; Open the output file:

                mov     ah, 3ch                 ;Create file.
                mov     cx, 0                   ;Normal attributes.
                lea     dx, FileName
                int     21h
                mov     FileHandle, ax          ;Save opened file handle.

; Force the standard output to send its output to this file.
; Do this by forcing the file's handle onto file handle #1 (stdout).

                mov     ah, 46h                 ;Force dup file handle
                mov     cx, 1                   ;Existing handle to change.
                mov     bx, FileHandle          ;New file handle to use.
                int     21h

; Print the first line to the file:

                print
                byte    &quot;Redirected directory listing:&quot;,cr,lf,0

; Okay, execute the DOS DIR command (that is, execute COMMAND.COM with
; the command line parameter &quot;/c DIR&quot;).

                mov     bx, seg ExecStruct
                mov     es, bx
                mov     bx, offset ExecStruct ;Ptr to program record.
                lds     dx, PgmName
                mov     ax, 4b00h               ;Exec pgm
                int     21h

                mov     bx, sseg                ;Reset the stack on return.
                mov     ss, ax
                mov     sp, offset EndStk
                mov     bx, seg dseg
                mov     ds, bx

; Okay, close the output file and switch standard output back to the
; console.

                mov     ah, 3eh                 ;Close output file.
                mov     bx, FileHandle
                int     21h

                mov     ah, 46h                 ;Force duplicate handle
                mov     cx, 1                   ;StdOut
                mov     bx, OrigOutHandle       ;Restore previous handle.
                int     21h

; Return control to MS-DOS

Quit:           ExitPgm
Main            endp
cseg            ends

sseg            segment para stack 'stack'
                dw      128 dup (0)
endstk          dw      ?
sseg            ends

zzzzzzseg       segment para public 'zzzzzzseg'
Heap            db      200h dup (?)
zzzzzzseg       ends
                end     Main</font></pre>
<div align="center"><center>

<table border="0" width="100%" cellspacing="0" cellpadding="0">
  <tr>
    <td width="100%" valign="middle" align="center" nowrap bgcolor="#000000" height="1" colspan="3"></td>
  </tr>
  <tr>
    <td width="34%" valign="middle" align="center" bgcolor="#FFFFFF"><p align="left"><a href="CH19-2.html"><img src="../images/WB00823_.GIF" align="absmiddle" border="0" WIDTH="12" HEIGHT="24"></a> <font face="Arial" size="2"><strong><a href="CH19-2.html">Chapter Nineteen</a> (Part 2)</strong></font></td>
    <td width="33%" valign="middle" align="center" bgcolor="#FFFFFF"><font face="Arial" size="2"><strong><a href="../toc.html">Table of Content</a></strong></font></td>
    <td width="33%" valign="middle" align="center" bgcolor="#FFFFFF"><font face="Arial" size="2"><strong><p align="right"><a href="CH19-4.html">Chapter Nineteen</a> (Part 4) <a href="CH19-4.html"><img src="../images/WB00827_.GIF" align="absmiddle" border="0" WIDTH="12" HEIGHT="24"></a></strong></font></td>
  </tr>
</table>
</center></div>

<p align="right"><font face="Arial" size="2"><strong>Chapter Nineteen: Processes,
Coroutines and Concurrency (Part 3)<br>
29 SEP 1996</strong></font></p>
</body>

<!-- Mirrored from www.arl.wustl.edu/~lockwood/class/cs306/books/artofasm/Chapter_19/CH19-3.html by HTTrack Website Copier/3.x [XR&CO'2008], Fri, 05 Dec 2008 15:28:45 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
</html>
