<html>
<!-- Generated by Harlequin WebMaker 2.2.6 (30-Apr-1996)Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->


<!-- Mirrored from www.arl.wustl.edu/~lockwood/class/cs306/books/artofasm/Chapter_22/CH22-1.html by HTTrack Website Copier/3.x [XR&CO'2008], Fri, 05 Dec 2008 15:28:58 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta http-equiv="pragma" content="no-cache">
<title>CHAPTER TWENTY TWO: THE PC SERIAL PORTS (Part 1)</title>
</head>

<body topmargin="10" stylesrc="../toc.html" bgcolor="#FFFFFF" text="#000000" link="#008000" vlink="#000000">
<div align="center"><center>

<table border="0" width="100%" cellspacing="0" cellpadding="0">
  <tr>
    <td width="100%" colspan="3"><p align="right"><a name="top"></a><font size="1" face="Arial">The Art of<br>
    </font><font face="Arial Black" size="1">ASSEMBLY LANGUAGE PROGRAMMING</font></td>
  </tr>
  <tr>
    <td width="100%" valign="middle" align="center" nowrap bgcolor="#000000" height="1" colspan="3"><a NAME="HEADING1"></a></td>
  </tr>
  <tr>
    <td width="34%" valign="middle" align="center" bgcolor="#FFFFFF" nowrap><p align="left"><a href="../Chapter_21/CH21-1.html"><img src="../images/WB00823_.GIF" align="absmiddle" border="0" WIDTH="12" HEIGHT="24"></a><font face="Arial" size="2"><strong> <a href="../Chapter_21/CH21-1.html">Chapter Twenty One</a></strong></font></td>
    <td width="33%" valign="middle" align="center" bgcolor="#FFFFFF" nowrap><a href="../toc.html"><font face="Arial" size="2"><strong>Table of Content</strong></font></a></td>
    <td width="33%" valign="middle" align="center" bgcolor="#FFFFFF" nowrap><p align="right"><font face="Arial" size="2"><strong><a href="CH22-2.html">Chapter Twenty Two</a> (Part 2)&nbsp; </strong></font><a href="CH22-2.html"><img src="../images/WB00827_.GIF" align="absmiddle" border="0" WIDTH="12" HEIGHT="24"></a></td>
  </tr>
</table>
</center></div><div align="center"><center>

<table border="0" width="100%" cellspacing="0" cellpadding="0">
  <tr>
    <td width="100%" colspan="3" bgcolor="#FFFFFF" nowrap height="10"><a NAME="HEADING1-0"></a></td>
  </tr>
  <tr>
    <td width="100%" colspan="3" bgcolor="#F0F0F0"><font face="Arial" size="4"><strong>CHAPTER
    TWENTY TWO:<br>
    THE PC SERIAL PORTS (Part 1)</strong></font></td>
  </tr>
  <tr>
    <td width="100%" colspan="3" nowrap height="10"></td>
  </tr>
  <tr>
    <td width="40%" valign="top"><font face="Arial" size="2"><a HREF="#HEADING1-5"><b>22.1 </b>-
    The 8250 Serial Communications Chip</a> <br>
    <a HREF="#HEADING1-12"><b>22.1.1 </b>- The Data Register (Transmit/Receive Register)</a> <br>
    <a HREF="#HEADING1-14"><b>22.1.2 </b>- The Interrupt Enable Register (IER)</a> <br>
    <a HREF="#HEADING1-18"><b>22.1.3 </b>- The Baud Rate Divisor</a> <br>
    <a HREF="#HEADING1-23"><b>22.1.4 </b>- The Interrupt Identification Register (IIR)</a> <br>
    <a HREF="#HEADING1-39"><b>22.1.5 </b>- The Line Control Register</a> <br>
    <a HREF="#HEADING1-49"><b>22.1.6 </b>- The Modem Control Register</a> <br>
    <a HREF="#HEADING1-60"><b>22.1.7 </b>- The Line Status Register (LSR)</a> <br>
    <a HREF="#HEADING1-70"><b>22.1.8 </b>- The Modem Status Register (MSR)</a> <br>
    <a HREF="#HEADING1-78"><b>22.1.9 </b>- The Auxiliary Input Register</a> <br>
    <a HREF="CH22-2.html#HEADING2-1" tppabs="http://webster.cs.ucr.edu/asm/ArtofAssembly/CH22/CH22-2.html#HEADING2-1"><b>22.2 </b>-
    The UCR Standard Library Serial Communications Support Routines</a> <br>
    <a HREF="CH22-2.html#HEADING2-7" tppabs="http://webster.cs.ucr.edu/asm/ArtofAssembly/CH22/CH22-2.html#HEADING2-7"><b>22.3 </b>-
    Programming the 8250 (Examples from the Standard Library)</a> </font></td>
    <td width="20" nowrap valign="top"></td>
    <td width="60%" valign="top"><font size="1" face="Arial">Copyright 1996 by Randall Hyde
    All rights reserved. <br>
    <br>
    Duplication other than for immediate display through a browser is prohibited by U.S.
    Copyright Law. <br>
    This material is provided on-line as a beta-test of this text. It is for the personal use
    of the reader only. If you are interested in using this material as part of a course,
    please contact rhyde@cs.ucr.edu <br>
    <br>
    Supporting software and other materials are available via anonymous ftp from
    ftp.cs.ucr.edu. See the &quot;/pub/pc/ibmpcdir&quot; directory for details. You may also
    download the material from &quot;Randall Hyde's Assembly Language Page&quot; at URL:
    http://webster.ucr.edu<br>
    <br>
    Notes: <br>
    This document does not contain the laboratory exercises, programming assignments,
    exercises, or chapter summary. These portions were omitted for several reasons: either
    they wouldn't format properly, they contained hyperlinks that were too much work to
    resolve, they were under constant revision, or they were not included for security
    reasons. Such omission should have very little impact on the reader interested in learning
    this material or evaluating this document. <br>
    <br>
    This document was prepared using Harlequin's Web Maker 2.2 and Quadralay's Webworks
    Publisher. Since HTML does not support the rich formatting options available in
    Framemaker, this document is only an approximation of the actual chapter from the
    textbook. <br>
    <br>
    If you are absolutely dying to get your hands on a version other than HTML, you might
    consider having the UCR Printing a Reprographics Department run you off a copy on their
    Xerox machines. For details, please read the following EMAIL message I received from the
    Printing and Reprographics Department: </font><blockquote>
      <p><font size="1" face="Arial">Hello Again Professor Hyde,<br>
      <br>
      Dallas gave me permission to take orders for the Computer Science 13 Manuals. We would
      need to take charge card orders. The only cards we take are: Master Card, Visa, and
      Discover. They would need to send the name, numbers, expiration date, type of card, and
      authorization to charge $95.00 for the manual and shipping, also we should have their
      phone number in case the company has any trouble delivery. They can use my e-mail address
      for the orders and I will process them as soon as possible. I would assume that two weeks
      would be sufficient for printing, packages and delivery time.<br>
      <br>
      I am open to suggestions if you can think of any to make this as easy as possible.<br>
      <br>
      Thank You for your business,<br>
      Kathy Chapman, Assistant<br>
      Printing and Reprographics University of California Riverside (909) 787-4443/4444 </font></p>
    </blockquote>
    <p><font size="1" face="Arial">We are currently working on ways to publish this text in a
    form other than HTML (e.g., Postscript, PDF, Frameviewer, hard copy, etc.). This, however,
    is a low-priority project. Please do not contact Randall Hyde concerning this effort. When
    something happens, an announcement will appear on &quot;Randall Hyde's Assembly Language
    Page.&quot; Please visit this WEB site at http://webster.ucr.edu for the latest scoop.</font></p>
    <p><font size="1" face="Arial">Redesigned 10/2000 with &quot;MS FrontPage 98&quot; using
    17&quot; monitor 1024x768<br>
    (c)&nbsp; 2000 <a href="mail%20to_%20bircom_yanoo.html">BIRCOM Entertainment'95</a></font></td>
  </tr>
</table>
</center></div>

<hr noshade size="1" color="#000000">

<p><font face="Arial" size="2">The RS-232 serial communication standard is probably the
most popular serial communication scheme in the world. Although it suffers from many
drawbacks, speed being the primary one, it use is widespread and there are literally
thousands of devices you can connect to a PC using an RS-232 interface. The PC supports up
to four RS-232 compatible devices using the COM1:, COM2:, COM3:, and COM4: devices<a HREF="#FOOTNOTE-1">[1]</a>. For those who need even more serial devices (e.g., to control
an electronic bulletin board system [BBS], you can even buy devices that let you add 16,
or more, serial ports to the PC. Since most PCs only have one or two serial ports, we will
concentrate on how to use COM1: and COM2: in this chapter.</font></p>

<p><font face="Arial" size="2">Although, in theory, the PC's original design allows system
designers to implement the serial communication ports using any hardware they desire, much
of today's software that does serial communication talks directly to the 8250 Serial
Communications Chip (SCC) directly. This introduces the same compatibility problems you
get when you talk directly to the parallel port hardware. However, whereas the BIOS
provides an excellent interface to the parallel port, supporting anything you would wish
to do by going directly to the hardware, the serial support is not so good. Therefore, it
is common practice to bypass the BIOS int 14h functions and control the 8250 SCC chip
directly so software can access every bit of every register on the 8250.</font></p>

<p><font face="Arial" size="2">Perhaps an even greater problem with the BIOS code is that
it does not support interrupts. Although software controlling parallel ports rarely uses
interrupt driven I/O<a HREF="#FOOTNOTE-2">[2]</a>, it is very common to find software that
provides interrupt service routines for the serial ports. Since the BIOS does not provide
such routines, any software that wants to use interrupt driven serial I/O will need to
talk directly to the 8250 and bypass BIOS anyway. Therefore, the first part of this
chapter will discuss the 8250 chip.</font></p>

<p><font face="Arial" size="2">Manipulating the serial port is not difficult. However, the
8250 SCC contains lots of registers and provides many features. Therefore it takes a lot
of code to control every feature of the chip. Fortunately, you do not have to write that
code yourself. The UCR Standard Library provides an excellent set of routines that let you
control the 8250. They even an interrupt service routine allowing interrupt driven I/O.
The second part of this chapter will present the code from the Standard Library as an
example of how to program each of the registers on the 8250 SCC.</font></p>
<div align="center"><center>

<table border="0" width="100%" cellspacing="0" cellpadding="0">
  <tr>
    <td width="100%"><strong><font face="Arial" size="3"><a NAME="HEADING1-5"></a>22.1 The
    8250 Serial Communications Chip</font></strong></td>
  </tr>
  <tr>
    <td width="100%" nowrap bgcolor="#000000" height="1"></td>
  </tr>
</table>
</center></div>

<p><font face="Arial" size="2">The 8250 and compatible chips (like the 16450 and 16550
devices) provide nine I/O registers. Certain upwards compatible devices (e.g., 16450 and
16550) provide a tenth register as well. These registers consume eight I/O port addresses
in the PC's address space. The hardware and locations of the addresses for these devices
are the following:</font></p>
<div align="center"><center>

<table BORDER="1" bordercolor="#C0C0C0" cellspacing="0" cellpadding="0" width="40%">
  <caption><strong><font face="Arial" size="2">COM Port Addresses</font></strong></caption>
  <tr>
    <th bgcolor="#F0F0F0"><font face="Arial" size="2">Port</font></th>
    <th bgcolor="#F0F0F0"><font face="Arial" size="2">Physical Base Address (in hex)</font></th>
    <th bgcolor="#F0F0F0"><font face="Arial" size="2">BIOS variable Containing Physical
    Address</font></th>
  </tr>
  <tr>
    <td><font face="Arial" size="2">COM1:</font></td>
    <td><font face="Arial" size="2">3F8</font></td>
    <td><font face="Arial" size="2">40:0</font></td>
  </tr>
  <tr>
    <td><font face="Arial" size="2">COM2:</font></td>
    <td><font face="Arial" size="2">2F8</font></td>
    <td><font face="Arial" size="2">40:2</font></td>
  </tr>
</table>
</center></div>

<p><font face="Arial" size="2">Like the PC's parallel ports, we can swap COM1: and COM2:
at the software level by swapping their base addresses in BIOS variable 40:0 and 40:2.
However, software that goes directly to the hardware, especially interrupt service
routines for the serial ports, needs to deal with hardware addresses, not logical
addresses. Therefore, we will always mean I/O base address 3F8h when we discuss COM1: in
this chapter. Likewise, we will always mean I/O base address 2F8h when we discuss COM2: in
this chapter.</font></p>

<p><font face="Arial" size="2">The base address is the first of eight I/O locations
consumed by the 8250 SCC. The exact purpose of these eight I/O locations appears in the
following table:</font></p>
<div align="center"><center>

<table BORDER="1" bordercolor="#C0C0C0" cellspacing="0" cellpadding="0" width="60%">
  <caption><strong><font face="Arial" size="2">8250 SCC Registers</font></strong></caption>
  <tr>
    <th bgcolor="#F0F0F0"><font face="Arial" size="2">I/O Address (hex)</font></th>
    <th bgcolor="#F0F0F0"><font face="Arial" size="2">Description</font></th>
  </tr>
  <tr>
    <td><font face="Arial" size="2">3F8/2F8</font></td>
    <td><font face="Arial" size="2">Receive/Transmit data register. Also the L.O. byte of the
    Baud Rate Divisor Latch register.</font></td>
  </tr>
  <tr>
    <td><font face="Arial" size="2">3F9/2F9</font></td>
    <td><font face="Arial" size="2">Interrupt Enable Register. Also the H.O. byte of the Baud
    Rate Divisor Register.</font></td>
  </tr>
  <tr>
    <td><font face="Arial" size="2">3FA/2FA</font></td>
    <td><font face="Arial" size="2">Interrupt Identification Register (read only).</font></td>
  </tr>
  <tr>
    <td><font face="Arial" size="2">3FB/2FB</font></td>
    <td><font face="Arial" size="2">Line Control Register.</font></td>
  </tr>
  <tr>
    <td><font face="Arial" size="2">3FC/2FC</font></td>
    <td><font face="Arial" size="2">Modem Control Register.</font></td>
  </tr>
  <tr>
    <td><font face="Arial" size="2">3FD/2FD</font></td>
    <td><font face="Arial" size="2">Line Status Register (read only).</font></td>
  </tr>
  <tr>
    <td><font face="Arial" size="2">3FE/2FE</font></td>
    <td><font face="Arial" size="2">Modem Status Register (read only).</font></td>
  </tr>
  <tr>
    <td><font face="Arial" size="2">3FF/2FF</font></td>
    <td><font face="Arial" size="2">Shadow Receive Register (read only, not available on
    original PCs).</font></td>
  </tr>
</table>
</center></div>

<p><font face="Arial" size="2">The following sections describe the purpose of each of
these registers.</font></p>

<p><strong><font face="Arial" size="3"><a NAME="HEADING1-12"></a>22.1.1 The Data Register
(Transmit/Receive Register)</font></strong></p>

<p><font face="Arial" size="2">The data register is actually two separate registers: the
transmit register and the receive register. You select the transmit register by writing to
I/O addresses 3F8h or 2F8h, you select the receive register by reading from these
addresses. Assuming the transmit register is empty, writing to the transmit register
begins a data transmission across the serial line. Assuming the receive register is full,
reading the receive register returns the data. To determine if the transmitter is empty or
the receiver is full, see the Line Status Register. Note that the Baud Rate Divisor
register shares this I/O address with the receive and transmit registers. Please see
&quot;The Baud Rate Divisor&quot; and &quot;The Line Control Register&quot; for more
information on the dual use of this I/O location.</font></p>

<p><strong><font face="Arial" size="3"><a NAME="HEADING1-14"></a>22.1.2 The Interrupt
Enable Register (IER)</font></strong></p>

<p><font face="Arial" size="2">When operating in interrupt mode, the 8250 SCC provides
four sources of interrupt: the character received interrupt, the transmitter empty
interrupt, the communication error interrupt, and the status change interrupt. You can
individually enable or disable these interrupt sources by writing ones or zeros to the
8250 IER (Interrupt Enable Register). Writing a zero to a corresponding bit disables that
particular interrupt. Writing a one enables that interrupt. This register is read/write,
so you can interrogate the current settings at any time (for example, if you want to mask
in a particular interrupt without affecting the others). The layout of this register is</font></p>

<p align="center"><font face="Arial" size="2"><img SRC="images/ch22a.gif" tppabs="http://webster.cs.ucr.edu/asm/ArtofAssembly/CH22/ch22a.gif" NATURALSIZEFLAG="3" ALIGN="bottom" WIDTH="320" HEIGHT="140"> </font></p>

<p><font face="Arial" size="2">The interrupt enable register I/O location is also common
with the Baud Rate Divisor Register. Please see the next section and &quot;The Line
Control Register&quot; for more information on the dual use of this I/O location.</font></p>

<p><strong><font face="Arial" size="3"><a NAME="HEADING1-18"></a>22.1.3 The Baud Rate
Divisor</font></strong></p>

<p><font face="Arial" size="2">The Baud Rate Divisor Register is a 16 bit register that
shares I/O locations 3F8h/2F8h and 3F9h/2F9h with the data and interrupt enable registers.
Bit seven of the Line Control Register (see &quot;The Line Control Register&quot;) selects
the divisor register or the data/interrupt enable registers.</font></p>

<p><font face="Arial" size="2">The Baud Rate Divisor register lets you select the data
transmission rate (properly called bits per second, or bps, not baud<a HREF="#FOOTNOTE-4">[4]</a>).
The following table lists the values you should write to these registers to control the
transmission/reception rate:</font></p>
<div align="center"><center>

<table BORDER="1" bordercolor="#C0C0C0" cellspacing="0" cellpadding="0" width="50%">
  <caption><strong><font face="Arial" size="2">Baud Rate Divisor Register Values</font></strong></caption>
  <tr>
    <th bgcolor="#F0F0F0" align="center"><font face="Arial" size="2">Bits Per Second</font></th>
    <th bgcolor="#F0F0F0" align="center"><font face="Arial" size="2">3F9/3F9 Value</font></th>
    <th bgcolor="#F0F0F0" align="center"><font face="Arial" size="2">3F8/2F8 Value</font></th>
  </tr>
  <tr>
    <td align="center"><font face="Arial" size="2">110</font></td>
    <td align="center"><font face="Arial" size="2">4</font></td>
    <td align="center"><font face="Arial" size="2">17h</font></td>
  </tr>
  <tr>
    <td align="center"><font face="Arial" size="2">300</font></td>
    <td align="center"><font face="Arial" size="2">1</font></td>
    <td align="center"><font face="Arial" size="2">80h</font></td>
  </tr>
  <tr>
    <td align="center"><font face="Arial" size="2">600</font></td>
    <td align="center"><font face="Arial" size="2">0</font></td>
    <td align="center"><font face="Arial" size="2">C0h</font></td>
  </tr>
  <tr>
    <td align="center"><font face="Arial" size="2">1200</font></td>
    <td align="center"><font face="Arial" size="2">0</font></td>
    <td align="center"><font face="Arial" size="2">60h</font></td>
  </tr>
  <tr>
    <td align="center"><font face="Arial" size="2">1800</font></td>
    <td align="center"><font face="Arial" size="2">0</font></td>
    <td align="center"><font face="Arial" size="2">40h</font></td>
  </tr>
  <tr>
    <td align="center"><font face="Arial" size="2">2400</font></td>
    <td align="center"><font face="Arial" size="2">0</font></td>
    <td align="center"><font face="Arial" size="2">30h</font></td>
  </tr>
  <tr>
    <td align="center"><font face="Arial" size="2">3600</font></td>
    <td align="center"><font face="Arial" size="2">0</font></td>
    <td align="center"><font face="Arial" size="2">20h</font></td>
  </tr>
  <tr>
    <td align="center"><font face="Arial" size="2">4800</font></td>
    <td align="center"><font face="Arial" size="2">0</font></td>
    <td align="center"><font face="Arial" size="2">18h</font></td>
  </tr>
  <tr>
    <td align="center"><font face="Arial" size="2">9600</font></td>
    <td align="center"><font face="Arial" size="2">0</font></td>
    <td align="center"><font face="Arial" size="2">0Ch</font></td>
  </tr>
  <tr>
    <td align="center"><font face="Arial" size="2">19.2K</font></td>
    <td align="center"><font face="Arial" size="2">0</font></td>
    <td align="center"><font face="Arial" size="2">6</font></td>
  </tr>
  <tr>
    <td align="center"><font face="Arial" size="2">38.4K</font></td>
    <td align="center"><font face="Arial" size="2">0</font></td>
    <td align="center"><font face="Arial" size="2">3</font></td>
  </tr>
  <tr>
    <td align="center"><font face="Arial" size="2">56K</font></td>
    <td align="center"><font face="Arial" size="2">0</font></td>
    <td align="center"><font face="Arial" size="2">1</font></td>
  </tr>
</table>
</center></div>

<p><font face="Arial" size="2">You should only operate at speeds greater than 19.2K on
fast PCs with high performance SCCs (e.g., 16450 or 16550). Furthermore, you should use
high quality cables and keep your cables very short when running at high speeds. </font></p>

<p><strong><font face="Arial" size="3"><a NAME="HEADING1-23"></a>22.1.4 The Interrupt
Identification Register (IIR)</font></strong></p>

<p><font face="Arial" size="2">The Interrupt Identification Register is a read-only
register that specifies whether an interrupt is pending and which of the four interrupt
sources requires attention. This register has the following layout:</font></p>

<p align="center"><img SRC="images/ch22a1.gif" tppabs="http://webster.cs.ucr.edu/asm/ArtofAssembly/CH22/ch22a1.gif" NATURALSIZEFLAG="3" ALIGN="bottom" WIDTH="390" HEIGHT="158"> </p>

<p><font face="Arial" size="2">Since the IIR can only report one interrupt at a time, and
it is certainly possible to have two or more pending interrupts, the 8250 SCC prioritizes
the interrupts. Interrupt source 00 (status change) has the lowest priority and interrupt
source 11 (error or break) has the highest priority; i.e., the interrupt source number
provides the priority (with three being the highest priority).</font></p>

<p><font face="Arial" size="2">The following table describes the interrupt sources and how
you &quot;clear&quot; the interrupt value in the IIR. If two interrupts are pending and
you service the higher priority request, the 8250 SCC replaces the value in the IIR with
the identification of the next highest priority interrupt source. </font></p>
<div align="center"><center>

<table BORDER="1" bordercolor="#C0C0C0" cellspacing="0" cellpadding="0" width="100%">
  <caption><strong><font face="Arial" size="2">Interrupt Cause and Release Functions</font></strong></caption>
  <tr>
    <th bgcolor="#F0F0F0"><font face="Arial" size="2">Priority</font></th>
    <th bgcolor="#F0F0F0" align="center"><font face="Arial" size="2">ID Value</font></th>
    <th bgcolor="#F0F0F0"><font face="Arial" size="2">Interrupt</font></th>
    <th bgcolor="#F0F0F0"><font face="Arial" size="2">Caused By</font></th>
    <th bgcolor="#F0F0F0"><font face="Arial" size="2">Reset By</font></th>
  </tr>
  <tr>
    <td><font face="Arial" size="2">Highest</font></td>
    <td align="center"><font face="Arial" size="2">11b</font></td>
    <td><font face="Arial" size="2">Error or Break</font></td>
    <td><font face="Arial" size="2">Overrun error, parity error, framing error, or break
    interrupt.</font></td>
    <td><font face="Arial" size="2">Reading the Line Status Register.</font></td>
  </tr>
  <tr>
    <td><font face="Arial" size="2">Next to highest</font></td>
    <td align="center"><font face="Arial" size="2">10b</font></td>
    <td><font face="Arial" size="2">Data available</font></td>
    <td><font face="Arial" size="2">Data arriving from an external source in the Receive
    Register.</font></td>
    <td><font face="Arial" size="2">Reading the Receive Register.</font></td>
  </tr>
  <tr>
    <td><font face="Arial" size="2">Next to lowest</font></td>
    <td align="center"><font face="Arial" size="2">01b</font></td>
    <td><font face="Arial" size="2">Transmitter empty</font></td>
    <td><font face="Arial" size="2">The transmitter finishes sending data and is ready to
    accept additional data.</font></td>
    <td><font face="Arial" size="2">Reading the IIR (with an interrupt ID of 01b) or writing
    to the Data Register.</font></td>
  </tr>
  <tr>
    <td><font face="Arial" size="2">Lowest</font></td>
    <td align="center"><font face="Arial" size="2">00b</font></td>
    <td><font face="Arial" size="2">Modem Status</font></td>
    <td><font face="Arial" size="2">Change in clear to send, data set ready, ring indicator,
    or received line signal detect signals.</font></td>
    <td><font face="Arial" size="2">Reading the modem status register.</font></td>
  </tr>
</table>
</center></div>

<p><font face="Arial" size="2">One interesting point to note about the organization of the
IIR: the bit layout provides a convenient way to transfer control to the appropriate
section of the SCC interrupt service routine. Consider the following code:</font></p>

<pre><font face="Courier New" size="2">                 .
                 .
                 .
                in      al, dx          ;Read IIR.
                mov     bl, al
                mov     bh, 0
                jmp     HandlerTbl[bx]
HandlerTbl      word    RLSHandler, RDHandler, TEHandler, MSHandler</font></pre>

<p><font face="Arial" size="2">When an interrupt occurs, bit zero of the IIR will be zero.
The next two bits contain the interrupt source number and the H.O. five bits are all zero.
This lets us use the IIR value as the index into a table of pointers to the appropriate
handler routines, as the above code demonstrates.</font></p>

<p><strong><font face="Arial" size="3"><a NAME="HEADING1-39"></a>22.1.5 The Line Control
Register</font></strong></p>

<p><font face="Arial" size="2">The Line Control Register lets you specify the transmission
parameters for the SCC. This includes setting the data size, number of stop bits, parity,
forcing a break, and selecting the Baud Rate Divisor Register (see &quot;The Baud Rate
Divisor&quot;). The Line Control Register is laid out as follows:</font></p>

<p align="center"><font face="Arial" size="2"><img SRC="images/ch22a2.gif" tppabs="http://webster.cs.ucr.edu/asm/ArtofAssembly/CH22/ch22a2.gif" NATURALSIZEFLAG="3" ALIGN="bottom" WIDTH="362" HEIGHT="226"> </font></p>

<p><font face="Arial" size="2">The 8250 SCC can transmit serial data as groups of five,
six, seven, or eight bits. Most modern serial communication systems use seven or eight
bits for transmission (you only need seven bits to transmit ASCII, eight bits to transmit
binary data). By default, most applications transmit data using eight data bits. Of
course, you always read eight bits from the receive register; the 8250 SCC pads all H.O.
bits with zero if you are receiving less than eight bits. Note that if you are only
transmitting ASCII characters, the serial communications will run about 10% faster with
seven bit transmission rather than with eight bit transmission. This is an important thing
to keep in mind if you control both ends of the serial cable. On the other hand, you will
usually be connecting to some device that has a fixed word length, so you will have to
program the SCC specifically to match that device.</font></p>

<p><font face="Arial" size="2">A serial data transmission consists of a start bit, five to
eight data bits, and one or two stop bits. The start bit is a special signal that informs
the SCC (or other device) that data is arriving on the serial line. The stop bits are,
essentially, the absence of a start bit to provide a small amount of time between the
arrival of consecutive characters on the serial line. By selecting two stop bits, you
insert some additional time between the transmission of each character. Some older devices
may require this additional time or they will get confused. However, almost all modern
serial devices are perfectly happy with a single stop bit. Therefore, you should usually
program the chip with only one stop bit. Adding a second stop bit increases transmission
time by about 10%.</font></p>

<p><font face="Arial" size="2">The parity bits let you enable or disable parity and choose
the type of parity. Parity is an error detection scheme. When you enable parity, the SCC
adds an extra bit (the parity bit) to the transmission. If you select odd parity, the
parity bit contains a zero or one so that the L.O. bit of the sum of the data and parity
bits is one. If you select even parity, the SCC produces a parity bit such that the L.O.
bit of the sum of the parity and data bits is zero. The &quot;stuck parity&quot; values
(10b and 11b) always produce a parity bit of zero or one. The main purpose of the parity
bit is to detect a possible transmission error. If you have a long, noisy, or otherwise
bad serial communications channel, it is possible to lose information during transmission.
When this happens, it is unlikely that the sum of the bits will match the parity value.
The receiving site can detect this &quot;parity error&quot; and report the error in
transmission.</font></p>

<p><font face="Arial" size="2">You can also use the stuck parity values (10b and 11b) to
strip the eighth bit and always replace it with a zero or one during transmission. For
example, when transmitting eight bit PC/ASCII characters to a different computer system it
is possible that the PC's extended character set (those characters whose code is 128 or
greater) does not map to the same character on the destination machine. Indeed, sending
such characters may create problems on that machine. By setting the word size to seven
bits and the parity to enabled and stuck at zero, you can automatically strip out all H.O.
bits during transmission, replacing them with zero. Of course, if any extended characters
come along, the SCC will map them to possibly unrelated ASCII characters, but this is a
useful trick, on occasion.</font></p>

<p><font face="Arial" size="2">The break bit transmits a break signal to the remote system
as long as there is a one programmed in this bit position. You should not leave break
enabled while trying to transmit data. The break signal comes from the teletype days. A
break is similar to ctrl-C or ctrl-break on the PC's keyboard. It is supposed to interrupt
a program running on a remote system. Note that the SCC can detect an incoming break
signal and generate an appropriate interrupt, but this break signal is coming from the
remote system, it is not (directly) connected to the outgoing break signal the LCR
controls.</font></p>

<p><font face="Arial" size="2">Bit seven of the LCR is the Baud Rate Divisor Register
latch bit. When this bit contains a one, locations 3F8h/2F8h and 3F9h/2F9h become the Baud
Rate Divisor Register. When this bit contains a zero, those I/O locations correspond to
the Data Registers and the Interrupt Enable Registers. You should always program this bit
with a zero except while initializing the speed of the SCC. </font></p>

<p><font face="Arial" size="2">The LCR is a read/write register. Reading the LCR returns
the last value written to it.</font></p>

<p><strong><font face="Arial" size="3"><a NAME="HEADING1-49"></a>22.1.6 The Modem Control
Register</font></strong></p>

<p><font face="Arial" size="2">The 8250's Modem Control Register contains five bits that
let you directly control various output pins on the 8250 as well as enable the 8250's
loopback mode. The following diagram displays the contents of this register:</font></p>

<p align="center"><font face="Arial" size="2"><img SRC="images/ch22a3.gif" tppabs="http://webster.cs.ucr.edu/asm/ArtofAssembly/CH22/ch22a3.gif" NATURALSIZEFLAG="3" ALIGN="bottom" WIDTH="330" HEIGHT="156"> </font></p>

<p><font face="Arial" size="2">The 8250 routes the DTR and RTS bits directly to the DTR
and RTS lines on the 8250 chip. When these bits are one, the corresponding outputs are
active<a HREF="#FOOTNOTE-5">[5]</a>. These lines are two separate handshake lines for
RS-232 communications. </font></p>

<p><font face="Arial" size="2">The DTR signal is comparable to a busy signal. When a
site's DTR line is inactive, the other site is not supposed to transmit data to it. The
DTR line is a manual handshake line. It appears as the Data Set Ready (DSR) line on the
other side of the serial cable. The other device must explicitly check its DSR line to see
if it can transmit data. The DTR/DSR scheme is mainly intended for handshaking between
computers and modems.</font></p>

<p><font face="Arial" size="2">The RTS line provides a second form of handshake. It's
corresponding input signal is CTS (Clear To Send). The RTS/CTS handshake protocol is
mainly intended for directly connected devices like computers and printers. You may ask
&quot;why are there two separate, but orthogonal handshake protocols?&quot; The reason is
because RS-232C has developed over the last 100 years (from the days of the first
telegraphs) and is the result of combining several different schemes over the years.</font></p>

<p><font face="Arial" size="2">Out1 is a general purpose output on the SCC that has very
little use on the IBM PC. Some adapter boards connect this signal, other leave it
disconnected. In general, this bit has no function on PCs.</font></p>

<p><font face="Arial" size="2">The Interrupt Enable bit is a PC-specific item. This is
normally a general purpose output (OUT 2) on the 8250 SCC. However, IBM's designers
connected this output to an external gate to enable or disable all interrupts from the
SCC. This bit must be programmed with a one to enable interrupts. Likewise, you must
ensure that this bit contains a zero if you are not using interrupts.</font></p>

<p><font face="Arial" size="2">The loopback bit connects the transmitter register to the
receive register. All data sent out the transmitter immediately comes back in the receive
register. This is useful for diagnostics, testing software, and detecting the serial chip.
Note, unfortunately, that the loopback circuit will not generate any interrupts. You can
only use this technique with polled I/O.</font></p>

<p><font face="Arial" size="2">The remaining bits in the MCR are reserved should always
contain zero. Future versions of the SCC (or compatible chips) may use these bits for
other purposes, with zero being the default (8250 simulation) state.</font></p>

<p><font face="Arial" size="2">The MCR is a read/write register. Reading the MCR returns
the last value written to it.</font></p>

<p><strong><font face="Arial" size="3"><a NAME="HEADING1-60"></a>22.1.7 The Line Status
Register (LSR)</font></strong></p>

<p><font face="Arial" size="2">The Line Status Register (LSR) is a read-only register that
returns the current communication status. The bit layout for this register is the
following:</font></p>

<p align="center"><font face="Arial" size="2"><img SRC="images/ch22a4.gif" tppabs="http://webster.cs.ucr.edu/asm/ArtofAssembly/CH22/ch22a4.gif" NATURALSIZEFLAG="3" ALIGN="bottom" WIDTH="373" HEIGHT="174"> </font></p>

<p><font face="Arial" size="2">The data available bit is set if there is data available in
the Receive Register. This also generates an interrupt. Reading the data in the Receive
Register clears this bit.</font></p>

<p><font face="Arial" size="2">The 8250 Receive Register can only hold one byte at a time.
If a byte arrives and the program does not read it and then a second byte arrives, the
8250 wipes out the first byte with the second. The 8250 SCC sets the overrun error bit
when this occurs. Reading the LSR clears this bit (after reading the LSR). This error will
generate the high priority error interrupt.</font></p>

<p><font face="Arial" size="2">The 8250 sets the parity bit if it detects a parity error
when receiving a byte. This error only occurs if you have enabled the parity operation in
the LCR. The 8250 resets this bit after you read the LSR. When this error occurs, the 8250
will generate the error interrupt.</font></p>

<p><font face="Arial" size="2">Bit three is the framing error bit. A framing error occurs
if the 8250 receives a character without a valid stop bit. The 8250 will clear this bit
after you read the LSR. This error will generate the high priority error interrupt.</font></p>

<p><font face="Arial" size="2">The 8250 sets the break interrupt bit when it receives the
break signal from the transmitting device. This will also generate an error interrupt.
Reading the LSR clears this bit.</font></p>

<p><font face="Arial" size="2">The 8250 sets bit five, the transmitter holding register
empty bit, when it is okay to write another character to the Data Register. Note that the
8250 actually has two registers associated with the transmitter. The transmitter shift
register contains the data actually being shifted out over the serial line. The
transmitter holding register holds a value that the 8250 writes to the shift register when
it finishes shifting out a character. Bit five indicates that the holding register is
empty and the 8250 can accept another byte. Note that the 8250 might still be shifting out
a character in parallel with this operation. The 8250 can generate an interrupt when the
transmitter holding register is empty. Reading the LSR or writing to the Data Register
clears this bit.</font></p>

<p><font face="Arial" size="2">The 8250 sets bit six when both the transmitter holding and
transmitter shift registers are empty. This bit is clear when either register contains
data.</font></p>

<p><strong><font face="Arial" size="3"><a NAME="HEADING1-70"></a>22.1.8 The Modem Status
Register (MSR)</font></strong></p>

<p><font face="Arial" size="2">The Modem Status Register (MSR) reports the status of the
handshake and other modem signals. Four bits provide the instantaneous values of these
signals, the 8250 sets the other four bits if any of these signals change since the last
time the CPU interrogates the MSR. The MSR has the following layout:</font></p>

<p align="center"><font face="Arial" size="2"><img SRC="images/ch22a5.gif" tppabs="http://webster.cs.ucr.edu/asm/ArtofAssembly/CH22/ch22a5.gif" NATURALSIZEFLAG="3" ALIGN="bottom" WIDTH="350" HEIGHT="170"> </font></p>

<p><font face="Arial" size="2">The Clear To Send bit (bit #4) is a handshaking signal.
This is normally connected to the RTS (Request To Send) signal on the remove device. When
that remote device asserts its RTS line, data transmission can take place.</font></p>

<p><font face="Arial" size="2">The Data Set Ready bit (bit #5) is one if the remote device
is not busy. This input is generally connected to the Data Terminal Ready (DTR) line on
the remote device. </font></p>

<p><font face="Arial" size="2">The 8250 chip sets the Ring Indicator bit (bit #6) when the
modem asserts the ring indicator line. You will rarely use this signal unless you are
writing modem controlling software that automatically answers a telephone call.</font></p>

<p><font face="Arial" size="2">The Data Carrier Detect bit (DCD, bit #7) is another modem
specific signal. This bit contains a one while the modem detects a carrier signal on the
phone line.</font></p>

<p><font face="Arial" size="2">Bits zero through three of the MSR are the
&quot;delta&quot; bits. These bits contain a one if their corresponding modem status
signal changes. Such an occurrence will also generate a modem status interrupt. Reading
the MSR will clear these bits.</font></p>

<p><strong><font face="Arial" size="3"><a NAME="HEADING1-78"></a>22.1.9 The Auxiliary
Input Register</font></strong></p>

<p><font face="Arial" size="2">The auxiliary input register is available only on later
model 8250 compatible devices. This is a read-only register that returns the same value as
reading the data register. The difference between reading this register and reading the
data register is that reading the auxiliary input register does not affect the data
available bit in the LSR. This allows you to test the incoming data value without removing
it from the input register. This is useful, for example, when chaining serial chip
interrupt service routines and you want to handle certain &quot;hot&quot; values in one
ISR and pass all other characters on to a different serial ISR.</font></p>

<hr noshade size="1" color="#000000">

<p><font face="Arial" size="2"><strong><a NAME="FOOTNOTE-1"></a>[1] </strong>Most programs
support only COM1: and COM2:. Support for additional serial devices is somewhat limited
among various applications. </font></p>

<p><font face="Arial" size="2"><strong><a NAME="FOOTNOTE-2"></a>[2]</strong> Because many
parallel port adapters do not provide hardware support for interrupts. </font></p>

<p><font face="Arial" size="2"><strong><a NAME="FOOTNOTE-4"></a>[4]</strong> The term
&quot;baud&quot; describes the rate at which tones can change on a modem/telephone line.
It turns out that, with normal telephone lines, the maximum baud rate is 600 baud. Modems
that operate at 1200 bps use a different technique (beyond switching tones) to increase
the data transfer rate. In general, there is no such thing as a &quot;1200 baud,&quot;
&quot;9600 baud,&quot; or &quot;14.4 kbaud&quot; modem. Properly, these are 1200 bps,
9600bps, and 14.4K bps modems. </font></p>

<p><font face="Arial" size="2"><strong><a NAME="FOOTNOTE-5"></a>[5]</strong> It turns out
that the DTR and RTS lines are active low, so the 8250 actually inverts these lines on
their way out. However, the receiving site reinverts these lines so the receiving site (if
it is an 8250 SCC) will read these bits as one when they are active. See the description
of the line status register for details.</font></p>
<div align="center"><center>

<table border="0" width="100%" cellspacing="0" cellpadding="0">
  <tr>
    <td width="100%" valign="middle" align="center" nowrap bgcolor="#000000" height="1" colspan="3"></td>
  </tr>
  <tr>
    <td width="34%" valign="middle" align="center" bgcolor="#FFFFFF" nowrap><p align="left"><a href="../Chapter_21/CH21-1.html"><img src="../images/WB00823_.GIF" align="absmiddle" border="0" WIDTH="12" HEIGHT="24"></a><font face="Arial" size="2"><strong> <a href="../Chapter_21/CH21-1.html">Chapter Twenty One</a></strong></font></td>
    <td width="33%" valign="middle" align="center" bgcolor="#FFFFFF" nowrap><a href="../toc.html"><font face="Arial" size="2"><strong>Table of Content</strong></font></a></td>
    <td width="33%" valign="middle" align="center" bgcolor="#FFFFFF" nowrap><p align="right"><font face="Arial" size="2"><strong><a href="CH22-2.html">Chapter Twenty Two</a> (Part 2)&nbsp; </strong></font><a href="CH22-2.html"><img src="../images/WB00827_.GIF" align="absmiddle" border="0" WIDTH="12" HEIGHT="24"></a></td>
  </tr>
</table>
</center></div>

<p align="right"><font face="Arial" size="2"><strong>Chapter Twenty Two: The PC Serial
Ports (Part 1)<br>
30 SEP 1996</strong></font></p>
</body>

<!-- Mirrored from www.arl.wustl.edu/~lockwood/class/cs306/books/artofasm/Chapter_22/CH22-1.html by HTTrack Website Copier/3.x [XR&CO'2008], Fri, 05 Dec 2008 15:29:07 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
</html>
